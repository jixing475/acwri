# Complete Example R Package

This is a complete, working example of an R package that wraps a Python library using `uv` and `reticulate`.

## Package: examplepy

Wraps the hypothetical Python package `awesome_ml` which provides machine learning functionality.

## Directory Structure

```
examplepy/
├── DESCRIPTION
├── NAMESPACE  
├── README.md
├── R/
│   ├── zzz.R           # Package initialization
│   ├── utils.R         # Helper functions
│   ├── classifier.R    # Classifier wrappers
│   └── regressor.R     # Regressor wrappers
├── man/                # Documentation (auto-generated)
└── tests/
    └── testthat/
        ├── test-setup.R
        └── test-wrappers.R
```

## File Contents

### DESCRIPTION

```
Package: examplepy
Title: R Interface to Awesome ML Python Package
Version: 0.1.0
Authors@R: person("Your", "Name", email = "you@example.com", role = c("aut", "cre"))
Description: Provides R wrappers for the awesome_ml Python package,
    enabling machine learning workflows with Python backends from R.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
RoxygenNote: 7.2.0
Imports:
    reticulate (>= 1.28),
    memoise (>= 2.0.0)
Suggests:
    testthat (>= 3.0.0),
    knitr,
    rmarkdown
VignetteBuilder: knitr
```

### NAMESPACE

```
# Generated by roxygen2: do not edit by hand

export(AwesomeClassifier)
export(AwesomeRegressor)
export(get_awesome_ml)
import(reticulate)
```

### R/zzz.R

```r
# Package initialization
# This file contains the .onLoad hook that runs when the package is loaded

#' @import reticulate
.onLoad <- function(libname, pkgname) {
  # Check for user-specified environment variable
  user_venv <- Sys.getenv("EXAMPLEPY_VENV", "")
  
  if (user_venv != "" && dir.exists(user_venv)) {
    # User specified a custom environment
    packageStartupMessage("Using custom Python environment: ", user_venv)
    tryCatch({
      reticulate::use_virtualenv(user_venv, required = TRUE)
      .globals$py_module <- reticulate::import("awesome_ml", delay_load = TRUE)
    }, error = function(e) {
      packageStartupMessage(
        "Failed to use custom environment: ", e$message, "\n",
        "Falling back to automatic setup..."
      )
      setup_default_environment()
    })
  } else {
    # Use default automatic setup
    setup_default_environment()
  }
}

# Internal function for default environment setup
setup_default_environment <- function() {
  # Define persistent environment location
  venv_path <- file.path(Sys.getenv("HOME"), ".examplepy", "python_env")
  
  # Create directory if needed
  if (!dir.exists(dirname(venv_path))) {
    dir.create(dirname(venv_path), recursive = TRUE, showWarnings = FALSE)
  }
  
  # Create virtual environment if it doesn't exist
  if (!dir.exists(venv_path)) {
    packageStartupMessage("Creating Python virtual environment...")
    packageStartupMessage("This may take several minutes on first load...")
    
    tryCatch({
      # Create venv
      reticulate::virtualenv_create(venv_path, python = "python3")
      
      # Install required packages
      packageStartupMessage("Installing Python packages...")
      reticulate::virtualenv_install(
        venv_path,
        packages = c("awesome-ml", "numpy", "pandas"),
        pip_options = "--upgrade --no-cache-dir"
      )
      
      packageStartupMessage("Python environment setup complete!")
    }, error = function(e) {
      stop(
        "Failed to create Python environment: ", e$message, "\n",
        "Please install Python and try again, or set EXAMPLEPY_VENV to a custom environment."
      )
    })
  }
  
  # Use the environment
  tryCatch({
    reticulate::use_virtualenv(venv_path, required = TRUE)
    .globals$py_module <- reticulate::import("awesome_ml", delay_load = TRUE)
    packageStartupMessage("Python environment ready: ", venv_path)
  }, error = function(e) {
    stop("Failed to initialize Python environment: ", e$message)
  })
}

# Package-level globals
.globals <- new.env(parent = emptyenv())
.globals$py_module <- NULL
```

### R/utils.R

```r
# Utility functions for Python module access

#' Get awesome_ml Python Module
#'
#' Returns the awesome_ml Python module. This function is cached using memoise
#' to avoid repeated imports.
#'
#' @param venv_path Path to Python virtual environment. Default is "./venv".
#'   Note: This parameter is only effective before Python is initialized.
#'   After the first import, the environment is locked for the R session.
#'
#' @return Python module object
#' @export
#'
#' @examples
#' \dontrun{
#' # Get the module
#' ml <- get_awesome_ml()
#' 
#' # Access Python classes directly
#' custom_model <- ml$CustomModel()
#' }
get_awesome_ml <- function(venv_path = "./venv") {
  # If module already loaded via .onLoad, return it
  if (!is.null(.globals$py_module)) {
    return(.globals$py_module)
  }
  
  # Otherwise, try to load with specified venv_path
  tryCatch({
    reticulate::use_virtualenv(venv_path, required = TRUE)
    reticulate::import("awesome_ml", delay_load = TRUE)
  }, error = function(e) {
    stop(
      "Failed to import awesome_ml: ", e$message, "\n",
      "Please ensure Python and awesome_ml are installed.\n",
      "Setup: uv venv venv && uv pip install awesome-ml"
    )
  })
}

# Cache the function to avoid repeated imports
get_awesome_ml <- memoise::memoise(get_awesome_ml)

# Helper function to check if Python is available
check_python_available <- function() {
  if (!reticulate::py_available()) {
    stop(
      "Python is not available. Please install Python 3.7 or higher.\n",
      "Visit: https://www.python.org/downloads/"
    )
  }
  
  if (!reticulate::py_module_available("awesome_ml")) {
    stop(
      "Python package 'awesome_ml' is not installed.\n",
      "Install with: pip install awesome-ml"
    )
  }
}
```

### R/classifier.R

```r
# Wrapper functions for awesome_ml classifiers

#' Awesome Classifier
#'
#' Create a classifier using the awesome_ml Python package.
#'
#' @param n_estimators Number of estimators. Default is 100.
#' @param max_depth Maximum depth of trees. Default is NULL (unlimited).
#' @param learning_rate Learning rate. Default is 0.1.
#' @param random_state Random seed for reproducibility. Default is 42.
#' @param venv_path Path to Python virtual environment. Default is "./venv".
#'   Note: This parameter is only effective on first use in an R session.
#' @param ... Additional parameters passed to awesome_ml.AwesomeClassifier
#'
#' @return A Python object representing the classifier. Use `$fit()`, `$predict()`,
#'   and other methods to interact with the model.
#'
#' @section Python Requirements:
#' This function requires the Python package 'awesome-ml'.
#' Install with: `pip install awesome-ml`
#'
#' @export
#'
#' @examples
#' \dontrun{
#' # Create classifier
#' clf <- AwesomeClassifier(n_estimators = 200, max_depth = 10)
#' 
#' # Fit model
#' clf$fit(X_train, y_train)
#' 
#' # Make predictions
#' predictions <- clf$predict(X_test)
#' 
#' # Get accuracy
#' accuracy <- clf$score(X_test, y_test)
#' }
AwesomeClassifier <- function(
  n_estimators = 100L,
  max_depth = NULL,
  learning_rate = 0.1,
  random_state = 42L,
  venv_path = "./venv",
  ...) {
  
  # Get Python module
  ml <- get_awesome_ml(venv_path)
  
  # Call Python class
  ml$AwesomeClassifier(
    n_estimators = as.integer(n_estimators),
    max_depth = if (is.null(max_depth)) NULL else as.integer(max_depth),
    learning_rate = as.numeric(learning_rate),
    random_state = as.integer(random_state),
    ...
  )
}
```

### R/regressor.R

```r
# Wrapper functions for awesome_ml regressors

#' Awesome Regressor
#'
#' Create a regressor using the awesome_ml Python package.
#'
#' @param n_estimators Number of estimators. Default is 100.
#' @param max_depth Maximum depth of trees. Default is NULL (unlimited).
#' @param learning_rate Learning rate. Default is 0.1.
#' @param random_state Random seed for reproducibility. Default is 42.
#' @param venv_path Path to Python virtual environment. Default is "./venv".
#'   Note: This parameter is only effective on first use in an R session.
#' @param ... Additional parameters passed to awesome_ml.AwesomeRegressor
#'
#' @return A Python object representing the regressor. Use `$fit()`, `$predict()`,
#'   and other methods to interact with the model.
#'
#' @section Python Requirements:
#' This function requires the Python package 'awesome-ml'.
#' Install with: `pip install awesome-ml`
#'
#' @export
#'
#' @examples
#' \dontrun{
#' # Create regressor
#' reg <- AwesomeRegressor(n_estimators = 200, max_depth = 10)
#' 
#' # Fit model
#' reg$fit(X_train, y_train)
#' 
#' # Make predictions
#' predictions <- reg$predict(X_test)
#' 
#' # Get R² score
#' r2 <- reg$score(X_test, y_test)
#' }
AwesomeRegressor <- function(
  n_estimators = 100L,
  max_depth = NULL,
  learning_rate = 0.1,
  random_state = 42L,
  venv_path = "./venv",
  ...) {
  
  # Get Python module
  ml <- get_awesome_ml(venv_path)
  
  # Call Python class
  ml$AwesomeRegressor(
    n_estimators = as.integer(n_estimators),
    max_depth = if (is.null(max_depth)) NULL else as.integer(max_depth),
    learning_rate = as.numeric(learning_rate),
    random_state = as.integer(random_state),
    ...
  )
}
```

### tests/testthat/test-setup.R

```r
# Tests for Python environment setup

test_that("Python is available", {
  skip_if_not(reticulate::py_available())
  expect_true(reticulate::py_available())
})

test_that("awesome_ml module can be imported", {
  skip_if_not(reticulate::py_available())
  skip_if_not(reticulate::py_module_available("awesome_ml"))
  
  ml <- get_awesome_ml()
  expect_true(!is.null(ml))
})

test_that("get_awesome_ml is memoised", {
  skip_if_not(reticulate::py_available())
  skip_if_not(reticulate::py_module_available("awesome_ml"))
  
  ml1 <- get_awesome_ml()
  ml2 <- get_awesome_ml()
  
  # Should return the same object (cached)
  expect_identical(ml1, ml2)
})
```

### tests/testthat/test-wrappers.R

```r
# Tests for wrapper functions

test_that("AwesomeClassifier can be created", {
  skip_if_not(reticulate::py_available())
  skip_if_not(reticulate::py_module_available("awesome_ml"))
  
  clf <- AwesomeClassifier(n_estimators = 50)
  
  # Check it's a Python object
  expect_s3_class(clf, "python.builtin.object")
})

test_that("AwesomeClassifier parameters work", {
  skip_if_not(reticulate::py_available())
  skip_if_not(reticulate::py_module_available("awesome_ml"))
  
  clf <- AwesomeClassifier(
    n_estimators = 200,
    max_depth = 10,
    learning_rate = 0.05
  )
  
  # Check parameters were set
  expect_equal(clf$n_estimators, 200)
  expect_equal(clf$max_depth, 10)
  expect_equal(clf$learning_rate, 0.05)
})

test_that("AwesomeRegressor can be created", {
  skip_if_not(reticulate::py_available())
  skip_if_not(reticulate::py_module_available("awesome_ml"))
  
  reg <- AwesomeRegressor(n_estimators = 50)
  
  # Check it's a Python object
  expect_s3_class(reg, "python.builtin.object")
})
```

### README.md

```markdown
# examplepy

R interface to the awesome_ml Python package.

## Installation

### 1. Install R package

```r
# Install from GitHub
remotes::install_github("username/examplepy")
```

### 2. Set up Python environment

#### Option A: Automatic (recommended for most users)

The package will automatically create a Python environment on first load:

```r
library(examplepy)
# Wait for automatic setup to complete...
```

#### Option B: Manual (recommended for advanced users)

Create your own Python environment:

```bash
# Using uv (fast)
uv venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
uv pip install awesome-ml

# Or using standard venv
python3 -m venv venv
source venv/bin/activate
pip install awesome-ml
```

Then use the package:

```r
library(examplepy)
clf <- AwesomeClassifier(venv_path = "./venv")
```

#### Option C: Custom environment via environment variable

```r
Sys.setenv(EXAMPLEPY_VENV = "/path/to/your/venv")
library(examplepy)
```

## Usage

### Classification

```r
library(examplepy)

# Create classifier
clf <- AwesomeClassifier(n_estimators = 200, max_depth = 10)

# Prepare data
X_train <- matrix(rnorm(1000), ncol = 10)
y_train <- sample(0:1, 100, replace = TRUE)
X_test <- matrix(rnorm(200), ncol = 10)
y_test <- sample(0:1, 20, replace = TRUE)

# Fit model
clf$fit(X_train, y_train)

# Make predictions
predictions <- clf$predict(X_test)

# Get accuracy
accuracy <- clf$score(X_test, y_test)
print(paste("Accuracy:", accuracy))
```

### Regression

```r
library(examplepy)

# Create regressor
reg <- AwesomeRegressor(n_estimators = 200, learning_rate = 0.05)

# Prepare data
X_train <- matrix(rnorm(1000), ncol = 10)
y_train <- rnorm(100)
X_test <- matrix(rnorm(200), ncol = 10)
y_test <- rnorm(20)

# Fit model
reg$fit(X_train, y_train)

# Make predictions
predictions <- reg$predict(X_test)

# Get R² score
r2 <- reg$score(X_test, y_test)
print(paste("R² score:", r2))
```

## Important Notes

### Single Python Environment Per Session

Once Python is initialized in an R session, the environment cannot be changed. The `venv_path` parameter is only effective on the first use.

To use a different Python environment, restart your R session.

### Python Requirements

- Python 3.7 or higher
- awesome-ml package

## Troubleshooting

### "Python is not available"

Install Python from https://www.python.org/downloads/

### "awesome_ml module not found"

Install the Python package:

```bash
pip install awesome-ml
```

### Environment setup fails

Try manual setup (Option B above) or check Python installation.

## License

MIT
```

## Key Features of This Example

1. **Hybrid environment management**: Automatic by default, but allows user override
2. **Complete documentation**: Every function has roxygen2 documentation
3. **Proper testing**: Tests with appropriate skip guards
4. **Error handling**: Graceful failures with helpful messages
5. **Caching**: Uses memoise for efficiency
6. **Type conversion**: Explicit integer/numeric conversions
7. **User-friendly**: Clear README with multiple setup options

## Adapting This Example

To adapt for your Python package:

1. Replace `awesome_ml` with your Python package name
2. Replace `examplepy` with your R package name
3. Update wrapper functions for your Python classes
4. Adjust parameters to match your Python API
5. Update documentation and examples
6. Modify tests for your specific functionality
